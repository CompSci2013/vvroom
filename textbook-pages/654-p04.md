---

### Step 654.2: Understanding Nested Data Transformation

The top models chart handles a more complex data structure:

```typescript
// Statistics structure
{
  modelsByManufacturer: {
    "Toyota": {
      "Camry": { total: 234, highlighted: 45 },
      "Corolla": { total: 189, highlighted: 32 }
    },
    "Honda": {
      "Accord": { total: 156, highlighted: 28 },
      "Civic": { total: 145, highlighted: 21 }
    }
  }
}
```

The transformation flattens this nested structure:

```typescript
Object.entries(statistics.modelsByManufacturer).forEach(([manufacturer, models]) => {
  Object.entries(models).forEach(([modelName, stats]) => {
    modelEntries.push([`${manufacturer} ${modelName}`, stats]);
  });
});
```

**Result:**

```typescript
modelEntries = [
  ["Toyota Camry", { total: 234, highlighted: 45 }],
  ["Toyota Corolla", { total: 189, highlighted: 32 }],
  ["Honda Accord", { total: 156, highlighted: 28 }],
  ["Honda Civic", { total: 145, highlighted: 21 }]
]
```

This creates a flat array suitable for sorting and slicing to get the top 20.

---

### Step 654.3: Understanding Dual Data Source Fallback

Notice the two code paths:

```typescript
if (hasSegmentedStats && statistics.modelsByManufacturer) {
  // Use nested structure with highlight support
} else {
  // Fallback: use topModels array
  const topModels = statistics.topModels.slice(0, 20);
  const modelLabels = topModels.map(m => `${m.manufacturer} ${m.name}`);
  const counts = topModels.map(m => m.instanceCount);
}
```

**Why two approaches?**

The API can return model data in two formats:

1. **Segmented format** (`modelsByManufacturer`) — Has highlight counts, needs flattening
2. **Array format** (`topModels`) — Pre-sorted array, simpler to use but no highlight data

The segmented format is preferred when available (for highlight support), but the fallback ensures the chart works with simpler API responses.

---

### Step 654.4: Understanding Label Format Conversion

The click handler converts display format to URL format:

```typescript
// Convert from "Manufacturer Model" to "Manufacturer:Model" format
const modelCombos = uniqueLabels.map(label => {
  // Replace first space with colon (manufacturer doesn't have spaces)
  return label.replace(' ', ':');
});
```

**Why this conversion?**

| Format | Purpose | Example |
|--------|---------|---------|
| Display | Human-readable chart labels | "Toyota Camry" |
| URL | Machine-parseable parameter | "Toyota:Camry" |

The colon separator enables the backend to split the value and query by both manufacturer AND model efficiently.

**Edge Case: Multi-Word Models**

Consider "Ford Mustang Mach-E":

```typescript
"Ford Mustang Mach-E".replace(' ', ':')
// Result: "Ford:Mustang Mach-E"
```

The first space becomes a colon, preserving "Mustang Mach-E" as the model name. This works because manufacturer names in this dataset don't contain spaces.