# 309: User Preferences Service

**Status:** Complete
**Depends On:** None (standalone)
**Blocks:** Phase 8 (Framework Components - for panel ordering)

---

## Learning Objectives

After completing this section, you will:
- Understand localStorage patterns for persistent state
- Know how to handle storage failures gracefully
- Recognize domain-aware key namespacing patterns
- Be able to implement a preferences service with reactive state

---

## Objective

Create the `UserPreferencesService` that persists user preferences (panel order, collapsed state) using localStorage with domain-aware namespacing and graceful degradation.

---

## Why

Users customize their experience:
- Drag panels to reorder them
- Collapse panels they don't use often
- Their preferences should persist across sessions

### Storage Options

| Option | Persistence | Sharing | Complexity |
|--------|-------------|---------|------------|
| Component state | None | None | Low |
| Service state | Session only | Same tab | Low |
| localStorage | Permanent | Same origin | Medium |
| Backend API | Permanent | All devices | High |

We use **localStorage** because:
- Works offline
- No backend required
- Suitable for UI preferences
- Falls back gracefully in private browsing

### Domain-Aware Namespacing

Vvroom supports multiple domains (automobile, agriculture, etc.). Each domain may have different panels and preferences. Keys are namespaced:

```
prefs:automobile:panelOrder → ['stats-1', 'chart-1', 'query-control']
prefs:automobile:collapsedPanels → ['chart-1']
prefs:agriculture:panelOrder → ['crop-stats', 'yield-chart']
```

### Graceful Degradation

localStorage can fail:
- Private browsing mode
- Storage quota exceeded
- SecurityError in iframes

The service:
1. Checks storage availability on init
2. Uses in-memory fallback if unavailable
3. Logs warnings in dev mode
4. Never crashes the app

---

## What

### Step 309.1: Create the User Preferences Service

Create the file `src/app/framework/services/user-preferences.service.ts`: