---

### Step 651.2: Understanding the Transform Method

The `transform` method is the heart of any chart data source. Let's break down its logic:

**Input Parameters:**

| Parameter | Type | Purpose |
|-----------|------|---------|
| `statistics` | `VehicleStatistics \| null` | Domain statistics from the API |
| `highlights` | `any` | Highlight filter state (for visual distinction) |
| `_selectedValue` | `string \| null` | Currently selected value (for active state) |
| `_containerWidth` | `number` | Container width for responsive sizing |

**Null Check:**

```typescript
if (!statistics || !statistics.byManufacturer) {
  return null;
}
```

If statistics are missing or the `byManufacturer` property is absent, return `null`. The chart component will handle this gracefully by showing an empty state.

**Segmentation Detection:**

```typescript
const isSegmented = entries.length > 0 &&
  typeof entries[0][1] === 'object' &&
  'total' in entries[0][1];
```

The API can return manufacturer data in two formats:

1. **Simple format:** `{ "Toyota": 234, "Honda": 187 }` — just counts
2. **Segmented format:** `{ "Toyota": { total: 234, highlighted: 45 }, ... }` — with highlight breakdown

We detect which format we have by checking if the first value is an object with a `total` property.

---

### Step 651.3: Understanding the Trace Structure

Plotly charts use "traces" — each trace is a data series. For the segmented case, we create two traces:

```typescript
traces = [
  {
    type: 'bar',
    name: 'Highlighted',
    x: manufacturers,       // Category labels on X axis
    y: highlightedCounts,   // Values on Y axis
    marker: { color: '#3B82F6' },  // Blue color
    hovertemplate: '<b>%{x}</b><br>Highlighted: %{y}<extra></extra>'
  },
  {
    type: 'bar',
    name: 'Other',
    x: manufacturers,
    y: otherCounts,
    marker: { color: '#9CA3AF' },  // Gray color
    hovertemplate: '<b>%{x}</b><br>Other: %{y}<extra></extra>'
  }
];
```

**Why Two Traces?**

When highlight filters are active, we want to show how much of each manufacturer's data matches the highlight criteria. The blue "Highlighted" bars show matching data; the gray "Other" bars show non-matching data. Stacking them shows the total while distinguishing the segments.

**The Hover Template:**

```
<b>%{x}</b><br>Highlighted: %{y}<extra></extra>
```

- `<b>%{x}</b>` — Bold manufacturer name
- `<br>` — Line break
- `Highlighted: %{y}` — Label and value
- `<extra></extra>` — Hides the trace name (which would otherwise appear)