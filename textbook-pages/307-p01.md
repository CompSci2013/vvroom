# 307: Popout Context Service

**Status:** Complete
**Depends On:** 208-popout-interface, 306-resource-management-service
**Blocks:** 308-popout-manager-service

---

## Learning Objectives

After completing this section, you will:
- Understand the BroadcastChannel API for cross-window communication
- Know how to determine if code is running in a pop-out window
- Recognize the messaging patterns for parent-child window coordination
- Be able to implement bidirectional communication between windows

---

## Objective

Create the `PopOutContextService` that determines whether the current window is a pop-out and provides messaging infrastructure for communication between the main window and pop-out windows.

---

## Why

Pop-out windows are a core feature of vvroom. Users can detach panels (statistics, charts) into separate browser windows for multi-monitor workflows. This creates a challenge: *how do these windows communicate?*

### The Pop-Out Challenge

When you call `window.open()`, the new window is essentially a separate instance:
- Different JavaScript context
- Different Angular application instance
- No shared services or state

We need a way for:
1. **Main window** → Detect when pop-out is ready
2. **Main window** → Send state updates to pop-out
3. **Pop-out** → Receive state updates
4. **Pop-out** → Notify main window it's closing

### Communication Options

| Option | Pros | Cons |
|--------|------|------|
| `window.opener` | Direct reference | Security restrictions, fragile |
| `postMessage()` | Standard API | Requires origin checks, complex |
| `BroadcastChannel` | Simple, bidirectional | Browser support (good since 2017) |
| `SharedWorker` | Powerful | Complex setup |

We use **BroadcastChannel** because:
- Simple API: `channel.postMessage()` and `channel.onmessage`
- Works across same-origin windows
- No need to track window references
- Automatic cleanup when windows close

### The Context Service Pattern

`PopOutContextService` serves two roles:

1. **In pop-out window**: Determines "I am a pop-out" and sets up messaging
2. **In main window**: Initializes as parent for pop-out management

```typescript
// Pop-out window
if (contextService.isInPopOut()) {
  contextService.initializeAsPopOut('statistics-panel');
}

// Main window
contextService.initializeAsParent();
```