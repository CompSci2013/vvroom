<div class="discover-container">
  <!-- Header -->
  <div class="discover-header">
    <h1>{{ domainConfig.domainLabel }}</h1>
    <span class="results-count">{{ (resourceService.totalResults$ | async) }} {{ (resourceService.totalResults$ | async) === 1 ? 'result' : 'results' }}</span>
  </div>

  <!-- Draggable Panels Container -->
  <div cdkDropList (cdkDropListDropped)="onPanelDrop($any($event))" class="panels-container">
    <ng-container *ngFor="let panelId of panelOrder">
      <!-- Panel Wrapper -->
      <div class="panel-wrapper" cdkDrag [attr.id]="'panel-' + panelId">
        <!-- Drag Handle -->
        <div class="panel-header">
          <div class="panel-title-group">
            <div cdkDragHandle class="drag-handle">
              <i class="pi pi-bars"></i>
            </div>
            <h3 class="panel-title">{{ getPanelTitle(panelId) }}</h3>
          </div>
          <div class="panel-actions">
            <button
              pButton
              type="button"
              [icon]="isPanelCollapsed(panelId) ? 'pi pi-chevron-right' : 'pi pi-chevron-down'"
              class="p-button-sm p-button-text"
              (click)="togglePanelCollapse(panelId)"
              [pTooltip]="isPanelCollapsed(panelId) ? 'Expand' : 'Collapse'"
              tooltipPosition="left">
            </button>
            <ng-container *ngIf="!isPanelPoppedOut(panelId)">
              <button
                pButton
                type="button"
                icon="pi pi-external-link"
                class="p-button-sm p-button-text"
                [attr.id]="'popout-' + panelId"
                (click)="popOutPanel(panelId, getPanelType(panelId))"
                pTooltip="Pop out to separate window"
                tooltipPosition="left">
              </button>
            </ng-container>
          </div>
        </div>
        <!-- Panel Content -->
        <ng-container *ngIf="!isPanelCollapsed(panelId)">
          <div>
            <!-- Query Control -->
            <ng-container *ngIf="panelId === 'query-control'">
              <ng-container *ngIf="!isPanelPoppedOut('query-control'); else queryControlPoppedOut">
                <div>
                  <app-query-control
                    [domainConfig]="domainConfig"
                    (urlParamsChange)="onUrlParamsChange($event)"
                    (clearAllFilters)="onClearAllFilters()">
                  </app-query-control>
                </div>
              </ng-container>
              <ng-template #queryControlPoppedOut>
                <div class="popout-placeholder">
                  <i class="pi pi-external-link"></i>
                  <span>Query Control is open in a separate window</span>
                </div>
              </ng-template>
            </ng-container>
            <!-- Query Panel (domain-agnostic filter panel) -->
            <ng-container *ngIf="panelId === 'query-panel'">
              <ng-container *ngIf="!isPanelPoppedOut('query-panel'); else queryPanelPoppedOut">
                <div>
                  <app-query-panel [domainConfig]="domainConfig"></app-query-panel>
                </div>
              </ng-container>
              <ng-template #queryPanelPoppedOut>
                <div class="popout-placeholder">
                  <i class="pi pi-external-link"></i>
                  <span>Query Panel is open in a separate window</span>
                </div>
              </ng-template>
            </ng-container>
            <!-- Manufacturer-Model Picker -->
            <ng-container *ngIf="panelId === 'manufacturer-model-picker'">
              <ng-container *ngIf="!isPanelPoppedOut('manufacturer-model-picker'); else manufacturerPickerPoppedOut">
                <div>
                  <app-base-picker
                    [configId]="'manufacturer-model-picker'"
                    (selectionChange)="onPickerSelectionChangeAndUpdateUrl($event)">
                  </app-base-picker>
                </div>
              </ng-container>
              <ng-template #manufacturerPickerPoppedOut>
                <div class="popout-placeholder">
                  <i class="pi pi-external-link"></i>
                  <span>Manufacturer-Model Picker is open in a separate window</span>
                </div>
              </ng-template>
            </ng-container>
            <!-- Statistics Panel (CDK Mixed Orientation Chart Grid) -->
            <ng-container *ngIf="panelId === 'statistics-panel-2'">
              <ng-container *ngIf="!isPanelPoppedOut('statistics-panel-2'); else statisticsPanel2PoppedOut">
                <div>
                  <app-statistics-panel-2
                    [domainConfig]="domainConfig"
                    [isPanelPoppedOut]="isPanelPoppedOut.bind(this)"
                    (chartPopOut)="onChartPopOut($event)">
                  </app-statistics-panel-2>
                </div>
              </ng-container>
              <ng-template #statisticsPanel2PoppedOut>
                <div class="popout-placeholder">
                  <i class="pi pi-external-link"></i>
                  <span>Statistics Panel 2 is open in a separate window</span>
                </div>
              </ng-template>
            </ng-container>
            <!-- Results Table (legacy - kept for backwards compatibility) -->
            <ng-container *ngIf="panelId === 'results-table'">
              <ng-container *ngIf="!isPanelPoppedOut('results-table'); else resultsTablePoppedOut">
                <div>
                  <app-results-table [domainConfig]="domainConfig"></app-results-table>
                </div>
              </ng-container>
              <ng-template #resultsTablePoppedOut>
                <div class="popout-placeholder">
                  <i class="pi pi-external-link"></i>
                  <span>Results Table is open in a separate window</span>
                </div>
              </ng-template>
            </ng-container>
            <!-- Dynamic Results Table (drag-drop columns, resizable widths) -->
            <ng-container *ngIf="panelId === 'basic-results-table'">
              <ng-container *ngIf="!isPanelPoppedOut('basic-results-table'); else basicResultsTablePoppedOut">
                <div>
                  <app-dynamic-results-table [domainConfig]="domainConfig"></app-dynamic-results-table>
                </div>
              </ng-container>
              <ng-template #basicResultsTablePoppedOut>
                <div class="popout-placeholder">
                  <i class="pi pi-external-link"></i>
                  <span>Results Table is open in a separate window</span>
                </div>
              </ng-template>
            </ng-container>
          </div>
        </ng-container>
      </div>
    </ng-container>
  </div>
</div>
