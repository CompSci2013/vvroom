<div class="ai-chat-container" [class.collapsed]="!isExpanded">
  <!-- Header -->
  <div class="chat-header">
    <div class="header-left">
      <i class="pi pi-comments"></i>
      <span class="header-title">AI Assistant</span>
      <ng-container *ngIf="connectionStatus === 'connected'">
        <span class="status-indicator connected" pTooltip="Connected to Mimir"></span>
      </ng-container>
      <ng-container *ngIf="connectionStatus === 'checking'">
        <span class="status-indicator checking" pTooltip="Checking connection..."></span>
      </ng-container>
      <ng-container *ngIf="connectionStatus !== 'connected' && connectionStatus !== 'checking'">
        <span class="status-indicator disconnected" pTooltip="Disconnected - Click to retry" (click)="retryConnection()"></span>
      </ng-container>
    </div>
    <div class="header-actions">
      <button
        pButton
        type="button"
        [pTooltip]="isDeepSeekMode ? 'DeepSeek ON - Click to disable' : 'DeepSeek OFF - Click to enable'"
        [class]="'p-button-text p-button-sm deepseek-toggle' + (isDeepSeekMode ? ' active' : '')"
        (click)="toggleDeepSeek()">
        <img src="assets/deepseek.png" alt="DeepSeek" class="deepseek-icon" />
      </button>
      <ng-container *ngIf="hasMessages">
        <button
          pButton
          type="button"
          icon="pi pi-trash"
          pTooltip="Clear chat"
          class="p-button-text p-button-sm"
          (click)="clearChat()">
        </button>
      </ng-container>
      <button
        pButton
        type="button"
        [icon]="isExpanded ? 'pi pi-chevron-down' : 'pi pi-chevron-up'"
        pTooltip="Toggle panel"
        class="p-button-text p-button-sm"
        (click)="toggleExpanded()">
      </button>
      <button
        pButton
        type="button"
        icon="pi pi-times"
        pTooltip="Close AI Assistant"
        class="p-button-text p-button-sm"
        (click)="close()">
      </button>
    </div>
  </div>

  <!-- Chat Body (collapsible) -->
  <ng-container *ngIf="isExpanded">
    <div class="chat-body">
      <!-- Messages Area -->
      <div class="messages-area" #messagesContainer>
        <ng-container *ngIf="!hasMessages && !isLoading">
          <div class="welcome-message">
            <i class="pi pi-sparkles"></i>
            <h3>Welcome to AI Assistant</h3>
            <ng-container *ngIf="hasApiContext; else noApiContext">
              <p>Ask me anything or search the vehicle database:</p>
              <ul class="example-queries">
                <li (click)="useExampleQuery('Show me all Chevrolet vehicles from 2020 to 2024')">Show me all Chevrolet vehicles from 2020 to 2024</li>
                <li (click)="useExampleQuery('Find Pickup trucks with more than 100 VIN records')">Find Pickup trucks with more than 100 VIN records</li>
                <li (click)="useExampleQuery('What Ford models are available?')">What Ford models are available?</li>
              </ul>
            </ng-container>
            <ng-template #noApiContext>
              <p>Ask me anything:</p>
              <ul class="example-queries">
                <li (click)="useExampleQuery('What can you help me with?')">What can you help me with?</li>
                <li (click)="useExampleQuery('Explain how this application works')">Explain how this application works</li>
                <li (click)="useExampleQuery('Tell me a fun fact')">Tell me a fun fact</li>
              </ul>
            </ng-template>
          </div>
        </ng-container>

        <ng-container *ngFor="let message of messages">
          <div [class]="getMessageClass(message)">
            <div class="message-content">
              <ng-container *ngIf="message.images?.length">
                <div class="message-images">
                  <ng-container *ngFor="let image of message.images; let idx = index">
                    <img [src]="'data:' + image.mimeType + ';base64,' + image.data" alt="Attached image" class="message-image" />
                  </ng-container>
                </div>
              </ng-container>
              <div class="message-text" [innerHTML]="renderContent(message.content)"></div>
              <ng-container *ngIf="message.timestamp">
                <div class="message-time">{{ formatTime(message.timestamp) }}</div>
              </ng-container>
            </div>
          </div>
        </ng-container>

        <ng-container *ngIf="isLoading">
          <div class="message message-assistant loading">
            <div class="message-content">
              <p-progressSpinner
                strokeWidth="3"
                [style]="{ width: '24px', height: '24px' }">
              </p-progressSpinner>
              <span class="loading-text">Thinking...</span>
            </div>
          </div>
        </ng-container>

        <ng-container *ngIf="error">
          <div class="error-message">
            <i class="pi pi-exclamation-triangle"></i>
            <span>{{ error }}</span>
            <button pButton type="button" label="Retry" icon="pi pi-refresh" class="p-button-text p-button-sm" (click)="retryConnection()"></button>
          </div>
        </ng-container>
      </div>

      <!-- Input Area -->
      <div class="input-area">
        <ng-container *ngIf="connectionStatus === 'disconnected'; else connectedInputArea">
          <div class="disconnected-notice">
            <i class="pi pi-wifi"></i>
            <span>Cannot connect to AI service on Mimir</span>
            <button pButton type="button" label="Retry" class="p-button-sm" (click)="retryConnection()"></button>
          </div>
        </ng-container>
        <ng-template #connectedInputArea>
          <!-- Pending Image Preview -->
          <ng-container *ngIf="pendingImage">
            <div class="pending-image-preview">
              <img [src]="getPendingImageUrl()" alt="Pending attachment" />
              <button
                pButton
                type="button"
                icon="pi pi-times"
                class="p-button-rounded p-button-danger p-button-sm remove-image-btn"
                (click)="clearPendingImage()"
                pTooltip="Remove image">
              </button>
            </div>
          </ng-container>
          <div class="input-row">
            <textarea
              #messageInput
              pInputTextarea
              [(ngModel)]="userMessage"
              placeholder="Type your message or paste an image..."
              [rows]="1"
              [disabled]="isLoading || connectionStatus !== 'connected'"
              (keydown)="onKeyDown($event)"
              (paste)="onPaste($event)"
              class="message-input"
              autoResize="true">
            </textarea>
            <button
              pButton
              type="button"
              icon="pi pi-send"
              class="send-button"
              [disabled]="(!userMessage.trim() && !pendingImage) || isLoading || connectionStatus !== 'connected'"
              (click)="sendMessage()">
            </button>
          </div>
        </ng-template>
      </div>
    </div>
  </ng-container>
</div>
