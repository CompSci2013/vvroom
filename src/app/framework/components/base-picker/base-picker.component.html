<ng-container *ngIf="activeConfig">
  <div class="picker-container" [attr.data-testid]="environment.includeTestIds ? 'picker-panel' : null">
    <!-- Table -->
    <p-table
      [value]="state.data"
      [loading]="state.loading"
      [lazy]="activeConfig!.pagination.mode === 'server'"
      [paginator]="true"
      [rows]="state.pageSize"
      [totalRecords]="state.totalCount"
      [rowsPerPageOptions]="activeConfig!.pagination.pageSizeOptions || [10, 20, 50, 100]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
      (onLazyLoad)="onLazyLoad($event)"
      styleClass="p-datatable-gridlines"
      responsiveLayout="scroll"
      [attr.data-testid]="environment.includeTestIds ? 'picker-table' : null"
      >
      <!-- Caption with search and actions -->
      <ng-template pTemplate="caption">
        <div class="table-caption">
          <!-- Search -->
          <ng-container *ngIf="activeConfig!.showSearch !== false">
            <div class="picker-search">
              <input
                type="text"
                pInputText
                [placeholder]="activeConfig!.searchPlaceholder || 'Search...'"
                [value]="state.searchTerm"
                (input)="onSearch($any($event.target).value)"
                class="search-input"
                />
            </div>
          </ng-container>
          <div class="table-actions">
            <button
              pButton
              type="button"
              label="Clear"
              icon="pi pi-times"
              class="p-button-outlined p-button-secondary"
              (click)="clearSelections()"
              [disabled]="state.selectedItems.length === 0"
            ></button>
            <button
              pButton
              type="button"
              label="Apply"
              icon="pi pi-check"
              class="p-button-primary"
              (click)="applySelections()"
              [disabled]="state.selectedItems.length === 0"
            ></button>
          </div>
        </div>
      </ng-template>
      <!-- Header -->
      <ng-template pTemplate="header">
        <tr>
          <!-- Select All Checkbox -->
          <th style="width: 3rem">
            <p-checkbox
              [ngModel]="allVisibleSelected"
              (onChange)="onSelectAll($any($event).checked)"
              [binary]="true"
              [disabled]="state.data.length === 0"
            ></p-checkbox>
          </th>
          <!-- Column Headers -->
          <ng-container *ngFor="let col of activeConfig!.columns">
            <th
              [pSortableColumn]="col.sortable ? fieldToString(col.field) : ''"
          [ngStyle]="{
            width: col.width,
            textAlign: col.align || 'left'
          }"
              >
              {{ col.header }}
              <ng-container *ngIf="col.sortable">
                <p-sortIcon
                  [field]="fieldToString(col.field)"
                ></p-sortIcon>
              </ng-container>
            </th>
          </ng-container>
        </tr>
      </ng-template>
      <!-- Body -->
      <ng-template pTemplate="body" let-row>
        <tr>
          <!-- Row Checkbox -->
          <td>
            <p-checkbox
              [ngModel]="isRowSelected(row)"
              (onChange)="onRowSelectionChange(row, $any($event).checked)"
              [binary]="true"
            ></p-checkbox>
          </td>
          <!-- Column Data -->
          <ng-container *ngFor="let col of activeConfig!.columns">
            <td
          [ngStyle]="{
            textAlign: col.align || 'left'
          }"
              >
              {{ row[col.field] }}
            </td>
          </ng-container>
        </tr>
      </ng-template>
      <!-- Empty Message -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="activeConfig!.columns.length + 1">
            <div class="empty-message">
              <i class="pi pi-inbox empty-icon"></i>
              <p>No data available</p>
            </div>
          </td>
        </tr>
      </ng-template>
      <!-- Loading -->
      <ng-template pTemplate="loadingbody">
        <ng-container *ngFor="let i of [1, 2, 3, 4, 5]">
          <tr>
            <td [attr.colspan]="activeConfig!.columns.length + 1">
              <div class="loading-row">
                <p-skeleton width="100%" height="2rem"></p-skeleton>
              </div>
            </td>
          </tr>
        </ng-container>
      </ng-template>
    </p-table>
    <!-- Error Display -->
    <ng-container *ngIf="state.error">
      <div class="picker-error">
        <p-message
          severity="error"
          [text]="state.error.message || 'An error occurred'"
        ></p-message>
      </div>
    </ng-container>
  </div>
</ng-container>
