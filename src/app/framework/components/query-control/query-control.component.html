<div class="query-control-panel" [attr.data-testid]="environment.includeTestIds ? 'query-control-panel' : null">
  <!-- Compact Header Bar with Dropdown and Actions -->
  <div class="control-header">
    <p-dropdown
      #filterFieldDropdown
      [options]="filterFieldOptions"
      [(ngModel)]="selectedField"
      placeholder="Add filter by field..."
      [filter]="true"
      filterPlaceholder="Search fields..."
      (onChange)="onFieldSelected($event)"
      (onHide)="onDropdownHide()"
      (keydown)="onDropdownKeydown($event)"
      [showClear]="false"
      optionLabel="label"
      optionValue="value"
      styleClass="filter-field-dropdown"
      [attr.data-testid]="environment.includeTestIds ? 'filter-field-dropdown' : null">
    </p-dropdown>
    <p-button
      label="Clear All"
      icon="pi pi-times"
      (onClick)="clearAll()"
      styleClass="p-button-secondary p-button-sm"
      [disabled]="!hasActiveFiltersOrHighlights()"
      [attr.data-testid]="environment.includeTestIds ? 'clear-all-button' : null">
    </p-button>
  </div>

  <!-- Active Filters -->
  <div class="active-filters" *ngIf="activeFilters.length > 0">
    <label class="active-filters-label">Active Filters:</label>
    <div class="filter-chips">
      <p-chip
        *ngFor="let filter of activeFilters"
        [label]="getChipLabel(filter)"
        [removable]="true"
        (onRemove)="removeFilter(filter); $event.stopPropagation()"
        (click)="onChipClick($event, filter)"
        styleClass="filter-chip"
        [pTooltip]="getChipTooltip(filter)"
        tooltipPosition="top">
      </p-chip>
    </div>
  </div>

  <!-- Active Highlights -->
  <div class="active-highlights" *ngIf="activeHighlights.length > 0">
    <div class="highlights-header">
      <label class="active-highlights-label">Active Highlights:</label>
      <a
        href="javascript:void(0)"
        class="clear-highlights-link"
        (click)="clearAllHighlights()">
        Clear All Highlights
      </a>
    </div>
    <div class="highlight-chips">
      <p-chip
        *ngFor="let highlight of activeHighlights"
        [label]="getChipLabel(highlight)"
        [removable]="true"
        (onRemove)="removeHighlight(highlight); $event.stopPropagation()"
        (click)="onHighlightChipClick($event, highlight)"
        styleClass="highlight-chip"
        [pTooltip]="getChipTooltip(highlight)"
        tooltipPosition="top">
      </p-chip>
    </div>
  </div>

  <!-- Multiselect Filter Dialog -->
  <p-dialog
    #multiselectDialog
    [(visible)]="showMultiselectDialog"
    [header]="multiselectDialogTitle"
    [modal]="true"
    [style]="{width: '50vw', minWidth: '400px'}"
    [closable]="true"
    [closeOnEscape]="true"
    [draggable]="false"
    [resizable]="false"
    (onShow)="onMultiselectDialogShow()"
    (onHide)="onDialogHide()">

    <ng-template pTemplate="header">
      <span>{{ multiselectDialogTitle }}</span>
    </ng-template>

    <p class="dialog-subtitle">{{ multiselectDialogSubtitle }}</p>

    <!-- Search Box -->
    <div class="p-input-icon-left search-box" *ngIf="!loadingOptions && !optionsError">
      <i class="pi pi-search"></i>
      <input
        #searchInput
        type="text"
        pInputText
        [(ngModel)]="searchQuery"
        [placeholder]="currentFilterDef?.searchPlaceholder || 'Search...'"
        (ngModelChange)="onSearchChange($event)"
        class="w-full"
        />
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="loadingOptions">
      <p-progressSpinner [style]="{width: '50px', height: '50px'}"></p-progressSpinner>
      <p>Loading options...</p>
    </div>

    <!-- Error State -->
    <div class="error-state" *ngIf="optionsError">
      <i class="pi pi-exclamation-triangle"></i>
      <p>{{ optionsError }}</p>
      <p-button
        label="Retry"
        icon="pi pi-refresh"
        (onClick)="retryLoadOptions()"
        styleClass="p-button-sm">
      </p-button>
    </div>

    <!-- Options List -->
    <div class="options-list" *ngIf="!loadingOptions && !optionsError">
      <div class="option-item" *ngFor="let option of filteredOptions; let i = index">
        <p-checkbox
          [(ngModel)]="selectedOptions"
          [value]="option.value"
          [binary]="false"
          [inputId]="'option-' + i">
        </p-checkbox>
        <label [for]="'option-' + i">{{ option.label }}</label>
      </div>
      <div class="no-results" *ngIf="filteredOptions.length === 0">
        <p>No options found</p>
      </div>
    </div>

    <!-- Selection Summary -->
    <div class="selection-summary" *ngIf="selectedOptions.length > 0 && !loadingOptions">
      <span>Selected ({{ selectedOptions.length }}): {{ getSelectionSummary() }}</span>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        (onClick)="cancelDialog()"
        styleClass="p-button-text p-button-secondary">
      </p-button>
      <p-button
        label="Apply"
        (onClick)="applyFilter()"
        styleClass="p-button-primary"
        [disabled]="selectedOptions.length === 0">
      </p-button>
    </ng-template>
  </p-dialog>

  <!-- Range Filter Dialog (Generic - supports integer, decimal, datetime) -->
  <p-dialog
    #rangeDialog
    [(visible)]="showRangeDialog"
    [header]="currentFilterDef?.dialogTitle || ('Select ' + (currentFilterDef?.label || 'Range'))"
    [modal]="true"
    [style]="{width: '500px'}"
    [closable]="true"
    [closeOnEscape]="true"
    [draggable]="false"
    [resizable]="false"
    (onShow)="onRangeDialogShow()"
    (onHide)="onDialogHide()">

    <p class="dialog-subtitle">{{ currentFilterDef?.dialogSubtitle || 'Select a range to filter results.' }}</p>

    <!-- Range Inputs (config-driven labels and formatting) -->
    <div class="range-inputs">
      <div class="p-field">
        <label for="rangeMin">{{ currentRangeConfig?.minLabel || 'Minimum' }}</label>
        <p-inputNumber
          id="rangeMin"
          [(ngModel)]="rangeMin"
          [min]="availableRange.min"
          [max]="availableRange.max"
          [useGrouping]="getRangeUseGrouping()"
          [placeholder]="currentRangeConfig?.minPlaceholder || ''"
          [showButtons]="true"
          [step]="getRangeStep()"
          [minFractionDigits]="getRangeDecimalPlaces()"
          [maxFractionDigits]="getRangeDecimalPlaces()">
        </p-inputNumber>
      </div>
      <div class="p-field">
        <label for="rangeMax">{{ currentRangeConfig?.maxLabel || 'Maximum' }}</label>
        <p-inputNumber
          id="rangeMax"
          [(ngModel)]="rangeMax"
          [min]="rangeMin || availableRange.min"
          [max]="availableRange.max"
          [useGrouping]="getRangeUseGrouping()"
          [placeholder]="currentRangeConfig?.maxPlaceholder || ''"
          [showButtons]="true"
          [step]="getRangeStep()"
          [minFractionDigits]="getRangeDecimalPlaces()"
          [maxFractionDigits]="getRangeDecimalPlaces()">
        </p-inputNumber>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        (onClick)="cancelDialog()"
        styleClass="p-button-text p-button-secondary">
      </p-button>
      <p-button
        label="Apply"
        (onClick)="applyRange()"
        styleClass="p-button-primary"
        [disabled]="rangeMin === null && rangeMax === null">
      </p-button>
    </ng-template>
  </p-dialog>
</div>
